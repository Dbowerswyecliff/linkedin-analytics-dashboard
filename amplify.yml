version: 1
backend:
  phases:
    build:
      commands:
        # Avoid strict peer-deps failures from upstream packages (e.g. @vibe/core transitive peers)
        - npm ci --cache .npm --prefer-offline --no-strict-peer-deps
        # Debug + robust env var fallback (Amplify may expose either AWS_* or AMPLIFY_* vars)
        - echo "ENV: AWS_BRANCH=${AWS_BRANCH} AMPLIFY_BRANCH=${AMPLIFY_BRANCH} AWS_APP_ID=${AWS_APP_ID} AMPLIFY_APP_ID=${AMPLIFY_APP_ID}"
        - npx ampx pipeline-deploy --branch "${AWS_BRANCH:-$AMPLIFY_BRANCH}" --app-id "${AWS_APP_ID:-$AMPLIFY_APP_ID}"
frontend:
  phases:
    preBuild:
      commands:
        - npm ci --cache .npm --prefer-offline --no-strict-peer-deps
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:
      - .npm/**/*
      - node_modules/**/*
